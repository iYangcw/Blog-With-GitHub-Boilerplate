<!DOCTYPE HTML>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Maverick,熊猫小A,Galileo,blog" />
    <meta name="generator" content="Maverick 1.1" />
    <meta name="template" content="Galileo" />
    <link rel="alternate" type="application/rss+xml" title="个人博客 &raquo; RSS 2.0" href="/Blog-With-GitHub-Boilerplate/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="个人博客 &raquo; ATOM 1.0" href="/Blog-With-GitHub-Boilerplate/feed/atom/index.xml" />
    <link rel="stylesheet" href="/Blog-With-GitHub-Boilerplate/assets/galileo-3f4dcc35c9.css">
    <link rel="stylesheet" href="/Blog-With-GitHub-Boilerplate/assets/ExSearch/ExSearch-182e5a8868.css">
    <link rel="stylesheet" href="/Blog-With-GitHub-Boilerplate/assets/katex.min.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700&display=swap">
    <script>
        var ExSearchConfig = {
            root: "",
            api: "/Blog-With-GitHub-Boilerplate/ce2336cc668a9acf6bee92c7c583d9fb.json"
        }
    </script>
    
<title>TCP发送窗口、接收窗口、wmem、rmem 关系 - 个人博客</title>
<meta name="author" content="Sai" />
<meta name="description" content="TCP发送窗口、接收窗口、wmem、rmem 关系" />
<meta property="og:title" content="TCP发送窗口、接收窗口、wmem、rmem 关系 - 个人博客" />
<meta property="og:description" content="TCP发送窗口、接收窗口、wmem、rmem 关系" />
<meta property="og:site_name" content="个人博客" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/Blog-With-GitHub-Boilerplate/archives/TCP发送窗口、接收窗口、wmem、rmem 关系/" />
<meta property="og:image" content="" />
<meta property="article:published_time" content="2023-05-01T14:00:00-00.00" />
<meta name="twitter:title" content="TCP发送窗口、接收窗口、wmem、rmem 关系 - 个人博客" />
<meta name="twitter:description" content="TCP发送窗口、接收窗口、wmem、rmem 关系" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="" />


    
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net" />

    </head>
    
    <body>
        
        <div class="container">
            <header id="ga-header">
                <div first>
                    <aside id="ga-brand">
                        <h1 class="brand"><a class="no-style" href="/Blog-With-GitHub-Boilerplate/">个人博客</a></h1>
                        <p>每天进步一点点</p>
                    </aside>
                </div>
                <div second id="ga-nav">
                    <nav class="navs">
                        <ul><li><a class="ga-highlight" href="/Blog-With-GitHub-Boilerplate/" target="_self">首页</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/Blog-With-GitHub-Boilerplate/archives/" target="_self">归档</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/Blog-With-GitHub-Boilerplate/about/" target="_self">关于</a></li><span class="separator">·</span><li><a href="#" target="_self" class="search-form-input ga-highlight">搜索</a></li></ul>
                    </nav>
                </div>
            </header>
            <div class="wrapper">
                
<main>    
    <section class="ga-section ga-content">
        <article class="yue">
            <h1 class="ga-post_title">TCP发送窗口、接收窗口、wmem、rmem 关系</h1>
            <span class="ga-post_meta ga-mono">
                <span>Sai</span>
                <time>
                    2023-05-01
                </time>
                
                in <a no-style class="category" href="/Blog-With-GitHub-Boilerplate/category/Maverick/">
                    Maverick
                </a>
                
                
            </span>
            <div class="ga-content_body">
                <h1>基础环境</h1>
<p><strong>服务器信息</strong></p>
<p>Client：192.168.56.100</p>
<p>Server：192.168.56.101</p>
<p>OS：CentOS Linux release 7.9.2009 (Core) 3.10.0-1160.el7.x86_64</p>
<p><strong>大致思路</strong></p>
<p>wmem 对应 <code>Send Buffer</code>，从 TCP 的概念可以理解为 发送窗口，字母 <code>w</code> 可以理解成 <code>write</code></p>
<p>rmem 对应 <code>Receive Buffer</code>，从 TCP 的概念可以理解为 接收窗口</p>
<p>实验过程是模拟一个下载过程，也就是大致过程是 <code>server</code> 发送文件，所以调整 <code>wmwm</code>，<code>client</code> 接收文件，所以调整 rmen</p>
<p><strong>目的如下：</strong></p>

<pre><code>写死 Linux参数让传输速度慢下来
改接收端：sysctl -w "net.ipv4.tcp_rmem=4096  4096    4096"
或者
改发送端：sysctl -w "net.ipv4.tcp_wmem=4096  4096    4096" 

继续调整rtt、丢包率，curl限制速度等，抓包分析看到的所有现象</code></pre>
<p><strong>系统默认参数如下</strong></p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>sudo<span class="w"> </span>sysctl<span class="w"> </span>-a<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span><span class="s2">&quot;rmem|wmem|tcp_mem|adv_win|moderate&quot;</span>
net.core.rmem_default<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">212992</span>
net.core.rmem_max<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">212992</span>
net.core.wmem_default<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">212992</span>
net.core.wmem_max<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">212992</span>
net.ipv4.tcp_adv_win_scale<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
net.ipv4.tcp_mem<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">42459</span><span class="w">    </span><span class="m">56612</span><span class="w">   </span><span class="m">84918</span>
net.ipv4.tcp_moderate_rcvbuf<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
net.ipv4.tcp_rmem<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4096</span><span class="w">    </span><span class="m">87380</span><span class="w">   </span><span class="m">6291456</span><span class="w"> </span>//最小值<span class="w">  </span>默认值<span class="w">  </span>最大值
net.ipv4.tcp_wmem<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4096</span><span class="w">    </span><span class="m">16384</span><span class="w">   </span><span class="m">4194304</span><span class="w"> </span>//最小值<span class="w">  </span>默认值<span class="w">  </span>最大值
net.ipv4.udp_rmem_min<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4096</span>
net.ipv4.udp_wmem_min<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4096</span>
vm.lowmem_reserve_ratio<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">256</span><span class="w">   </span><span class="m">256</span><span class="w"> </span><span class="m">32</span>
</pre></div>
<p><strong>开始命令</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># Client &amp;&amp; Server</span>
<span class="nv">clientIP</span><span class="o">=</span><span class="s2">&quot;192.168.56.100&quot;</span>
<span class="nv">serverIP</span><span class="o">=</span><span class="s2">&quot;192.168.56.101&quot;</span>

<span class="c1"># Server</span>
<span class="c1"># 启动命令的地方存在一个 2个多G 的文件</span>
python<span class="w"> </span>-m<span class="w"> </span>SimpleHTTPServer<span class="w"> </span><span class="m">8089</span>

<span class="c1">## Client</span>
curl<span class="w"> </span>http://192.168.56.101:8089/iso.tar<span class="w"> </span>--output<span class="w"> </span>./result

<span class="c1"># 测试宽带</span>
iperf3<span class="w"> </span>-s
iperf3<span class="w"> </span>-c<span class="w"> </span><span class="si">${</span><span class="nv">serverIP</span><span class="si">}</span><span class="w"> </span>-t<span class="w"> </span><span class="m">60</span><span class="w"> </span>-i<span class="w"> </span><span class="m">1</span>
<span class="c1"># 无额外设置情况下宽带结果</span>
大概是<span class="w"> </span><span class="m">2</span>.69<span class="w"> </span>Gbits/sec<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2860</span><span class="w"> </span>Mbps
</pre></div>
<p><strong>实验结果信息汇总</strong></p>
<div class="highlight"><pre><span></span>--正常<span class="w"> </span><span class="m">127</span><span class="w"> </span>MB/s

--延时<span class="w"> </span>100ms，5.48<span class="w"> </span>MB/s
client<span class="w"> </span>角度看的话，server发的包大小不稳定，60000-10000都有
server<span class="w"> </span>是以比较稳定的处理包，然后有100ms的延时

--延时<span class="w"> </span>100ms<span class="w"> </span>且client<span class="w"> </span>的<span class="w"> </span>rmem<span class="w"> </span>改成<span class="w"> </span><span class="m">4096</span>，17<span class="w"> </span>KB/s
client<span class="w"> </span>角度来看，包比较乱
server<span class="w"> </span>角度来说，连续小包（几千的样子）汇总发送,包的大小会有<span class="w"> </span>重复递增的样子

--延时<span class="w"> </span>100ms<span class="w"> </span>且server<span class="w"> </span>的<span class="w"> </span>wmem<span class="w"> </span>改成<span class="w"> </span><span class="m">4096</span>，80<span class="w"> </span>KB/s
client<span class="w"> </span>角度来看，一个ACK，然后一个稳定的接收<span class="w"> </span><span class="m">8258</span><span class="w"> </span>length<span class="w"> </span>的包
server<span class="w"> </span>是以比较稳定的处理包，然后有100ms的延时

--延时<span class="w"> </span>10ms<span class="w"> </span>且client<span class="w"> </span>的<span class="w"> </span>rmem<span class="w"> </span>改成<span class="w"> </span><span class="m">4096</span>，17<span class="w"> </span>KB/s
client<span class="w"> </span>角度来看，包比较乱
server<span class="w"> </span>角度来说，连续小包（几千的样子）汇总发送,包的大小会有<span class="w"> </span>重复递增的样子
</pre></div>
<h1>实验记录</h1>
<h2>实验一：正常状态</h2>
<div class="highlight"><pre><span></span><span class="c1"># Client</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>enp0s8<span class="w"> </span>-n<span class="w"> </span>host<span class="w">  </span><span class="si">${</span><span class="nv">serverIP</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span>client_01.pcap
<span class="c1"># Server</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>enp0s8<span class="w"> </span>-n<span class="w"> </span>host<span class="w">  </span><span class="si">${</span><span class="nv">clientIP</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span>server_01.pcap

<span class="c1"># 下载结果 大概平均下载速度是 127 MB/s</span>
$<span class="w"> </span>curl<span class="w"> </span>http://192.168.56.101:8089/iso.tar<span class="w"> </span>--output<span class="w"> </span>./result_01
<span class="w">  </span>%<span class="w"> </span>Total<span class="w">    </span>%<span class="w"> </span>Received<span class="w"> </span>%<span class="w"> </span>Xferd<span class="w">  </span>Average<span class="w"> </span>Speed<span class="w">   </span>Time<span class="w">    </span>Time<span class="w">     </span>Time<span class="w">  </span>Current
<span class="w">                                 </span>Dload<span class="w">  </span>Upload<span class="w">   </span>Total<span class="w">   </span>Spent<span class="w">    </span>Left<span class="w">  </span>Speed
<span class="m">100</span><span class="w"> </span>2539M<span class="w">  </span><span class="m">100</span><span class="w"> </span>2539M<span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">   </span>127M<span class="w">      </span><span class="m">0</span><span class="w">  </span><span class="m">0</span>:00:19<span class="w">  </span><span class="m">0</span>:00:19<span class="w"> </span>--:--:--<span class="w">  </span>130M
</pre></div>
<p>可以看到截图里，时间都是以 0.000X 秒递增的</p>
<p>client_01 截图</p>
<p><figure style="flex: 250.23809523809524" ><img width="2102" height="420" src="https://raw.githubusercontent.com/iYangcw/Photo/master/client_01.png" /></figure></p>
<p>server_01 截图</p>
<p><figure style="flex: 251.8028846153846" ><img width="2095" height="416" src="https://raw.githubusercontent.com/iYangcw/Photo/master/server_01.png" /></figure></p>
<h3>TCP  Windows  Scale</h3>
<p>Window Scale 选项只能与 TCP SYN、SYN/ACK 一起使用。TCP 早期的时候带宽很小，所以最大接收窗口被定义成 65535 字节（ TCP Header 的 Windows 最大为 16 bit ）</p>
<p>由于不够用，所以通过 TCP options 定义了 Windows  Scale，其声明了一个 Shift count，作为2的指数，再乘以 TCP 头中定义的接收窗口，就得到真正的 TCP 接收窗口了。</p>
<p>下图为 SYN/ACK 中可以看到 Windows  Scale 为 7</p>
<p><figure style="flex: 81.04651162790698" ><img width="1394" height="860" src="https://raw.githubusercontent.com/iYangcw/Photo/master/image-20230420161433041.png" /><figcaption>image-20230420161433041</figcaption></figure></p>
<p>下图为真实的 Windows size：29312 = 229 * 128</p>
<p><figure style="flex: 93.61147327249022" ><img width="1436" height="767" src="https://raw.githubusercontent.com/iYangcw/Photo/master/image-20230420161615849.png" /><figcaption>image-20230420161615849</figcaption></figure></p>
<h3>Window size</h3>
<p>TCP 层的 Windows size （或者如上述截图的 Windows 、Calculated windows size），是在向对方声明自己的<strong>接收窗口</strong>，而不是发送窗口</p>
<p>发送窗口决定了一口气能发多少字节，而 MSS 决定了这些字节要分多少个包发完。至于为什么 MSS=1460 的情况下，但是抓包的结果仍然有大于他的，这就是另外一个故事了，关键字：TCP Segment Offload</p>
<h2>实验二：server 增加 100ms 延时</h2>
<div class="highlight"><pre><span></span><span class="c1"># Server</span>
tc<span class="w"> </span>qdisc<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>enp0s8
tc<span class="w"> </span>qdisc<span class="w"> </span>del<span class="w"> </span>dev<span class="w"> </span>enp0s8<span class="w"> </span>root
tc<span class="w"> </span>qdisc<span class="w"> </span>add<span class="w"> </span>dev<span class="w"> </span>enp0s8<span class="w"> </span>root<span class="w"> </span>netem<span class="w"> </span>delay<span class="w"> </span>100ms
<span class="c1"># Client</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>enp0s8<span class="w"> </span>-n<span class="w"> </span>host<span class="w">  </span><span class="si">${</span><span class="nv">serverIP</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span>client_delay_100ms.pcap
<span class="c1"># Server</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>enp0s8<span class="w"> </span>-n<span class="w"> </span>host<span class="w">  </span><span class="si">${</span><span class="nv">clientIP</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span>server_delay_100ms.pcap

<span class="c1"># 结果，大概平均下载速度是 5.48 MB/s</span>
$<span class="w"> </span>curl<span class="w"> </span>http://192.168.56.101:8089/iso.tar<span class="w"> </span>--output<span class="w"> </span>./result
<span class="w">  </span>%<span class="w"> </span>Total<span class="w">    </span>%<span class="w"> </span>Received<span class="w"> </span>%<span class="w"> </span>Xferd<span class="w">  </span>Average<span class="w"> </span>Speed<span class="w">   </span>Time<span class="w">    </span>Time<span class="w">     </span>Time<span class="w">  </span>Current
<span class="w">                                 </span>Dload<span class="w">  </span>Upload<span class="w">   </span>Total<span class="w">   </span>Spent<span class="w">    </span>Left<span class="w">  </span>Speed
<span class="m">100</span><span class="w"> </span>2539M<span class="w">  </span><span class="m">100</span><span class="w"> </span>2539M<span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">  </span>5619k<span class="w">      </span><span class="m">0</span><span class="w">  </span><span class="m">0</span>:07:42<span class="w">  </span><span class="m">0</span>:07:42<span class="w"> </span>--:--:--<span class="w"> </span>4563k
</pre></div>
<p>server 抓包详情</p>
<p><figure style="flex: 218.38235294117646" ><img width="1485" height="340" src="https://raw.githubusercontent.com/iYangcw/Photo/master/image-20230501160506654.png" /><figcaption>image-20230501160506654</figcaption></figure></p>
<p>Wireshark 菜单路径：Statistics &gt;&gt; TCP Stream Graphs &gt;&gt; Time Sequence （Stevens）</p>
<p>Time Sequence （Stevens）图能看到两个点之间，time相减为 0.1秒</p>
<p><figure style="flex: 132.61851015801355" ><img width="2350" height="886" src="https://raw.githubusercontent.com/iYangcw/Photo/master/server_dely_100ms.png" /></figure></p>
<p><strong>我的实验过程中，Round Trip Time Graphs 看不出来 rtt 是固定 100ms 的。</strong>但是可以通过点击 Switch Direction 来看出 rtt</p>
<p><figure style="flex: 83.79446640316206" ><img width="1272" height="759" src="https://raw.githubusercontent.com/iYangcw/Photo/master/image-20230501160602666.png" /><figcaption>image-20230501160602666</figcaption></figure></p>
<h2>实验三：server 增加 100ms 延时，client 修改 rmem</h2>
<div class="highlight"><pre><span></span><span class="c1"># 两边原始值</span>
sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_wmem<span class="o">=</span><span class="s2">&quot;4096 16384 4194304&quot;</span>
sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_rmem<span class="o">=</span><span class="s2">&quot;4096 87380 6291456&quot;</span>
<span class="c1"># server</span>
tc<span class="w"> </span>qdisc<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>enp0s8
tc<span class="w"> </span>qdisc<span class="w"> </span>del<span class="w"> </span>dev<span class="w"> </span>enp0s8<span class="w"> </span>root
tc<span class="w"> </span>qdisc<span class="w"> </span>add<span class="w"> </span>dev<span class="w"> </span>enp0s8<span class="w"> </span>root<span class="w"> </span>netem<span class="w"> </span>delay<span class="w"> </span>100ms
<span class="c1"># client</span>
sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_rmem<span class="o">=</span><span class="s2">&quot;4096 4096 4096&quot;</span>

<span class="c1"># Client</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>enp0s8<span class="w"> </span>-n<span class="w"> </span>host<span class="w">  </span><span class="si">${</span><span class="nv">serverIP</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span>client_delayServer_100ms_rmem_Client_4096.pcap
<span class="c1"># Server</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>enp0s8<span class="w"> </span>-n<span class="w"> </span>host<span class="w">  </span><span class="si">${</span><span class="nv">clientIP</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span>server_delayServer_100ms_rmem_Client_4096.pcap

<span class="c1"># 结果, 大概平均下载速度是 17 KB/s</span>
$<span class="w"> </span>curl<span class="w"> </span>http://192.168.56.101:8089/iso.tar<span class="w"> </span>--output<span class="w"> </span>./result_01
<span class="w">  </span>%<span class="w"> </span>Total<span class="w">    </span>%<span class="w"> </span>Received<span class="w"> </span>%<span class="w"> </span>Xferd<span class="w">  </span>Average<span class="w"> </span>Speed<span class="w">   </span>Time<span class="w">    </span>Time<span class="w">     </span>Time<span class="w">  </span>Current
<span class="w">                                 </span>Dload<span class="w">  </span>Upload<span class="w">   </span>Total<span class="w">   </span>Spent<span class="w">    </span>Left<span class="w">  </span>Speed
<span class="w">  </span><span class="m">0</span><span class="w"> </span>2539M<span class="w">    </span><span class="m">0</span><span class="w"> </span>1399k<span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">  </span><span class="m">14436</span><span class="w">      </span><span class="m">0</span><span class="w"> </span><span class="m">51</span>:14:22<span class="w">  </span><span class="m">0</span>:01:39<span class="w"> </span><span class="m">51</span>:12:43<span class="w"> </span><span class="m">14458</span>
</pre></div>
<p>截图见<strong>实验一</strong>结论</p>
<h2>实验四：server 增加 100ms 延时，server 修改wmem</h2>
<div class="highlight"><pre><span></span><span class="c1"># 两边原始值</span>
sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_wmem<span class="o">=</span><span class="s2">&quot;4096 16384 4194304&quot;</span>
sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_rmem<span class="o">=</span><span class="s2">&quot;4096 87380 6291456&quot;</span>
<span class="c1"># Server</span>
tc<span class="w"> </span>qdisc<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>enp0s8
tc<span class="w"> </span>qdisc<span class="w"> </span>del<span class="w"> </span>dev<span class="w"> </span>enp0s8<span class="w"> </span>root
tc<span class="w"> </span>qdisc<span class="w"> </span>add<span class="w"> </span>dev<span class="w"> </span>enp0s8<span class="w"> </span>root<span class="w"> </span>netem<span class="w"> </span>delay<span class="w"> </span>100ms
sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_wmem<span class="o">=</span><span class="s2">&quot;4096 4096 4096&quot;</span>
<span class="c1"># Client</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>enp0s8<span class="w"> </span>-n<span class="w"> </span>host<span class="w">  </span><span class="si">${</span><span class="nv">serverIP</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span>client_delayServer_100ms_wmem_Server_4096.pcap
<span class="c1"># Server</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>enp0s8<span class="w"> </span>-n<span class="w"> </span>host<span class="w">  </span><span class="si">${</span><span class="nv">clientIP</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span>server_delayServer_100ms_wmem_Server_4096.pcap

<span class="c1"># 结果, 大概平均下载速度是 80 KB/s</span>
$<span class="w"> </span>curl<span class="w"> </span>http://192.168.56.101:8089/iso.tar<span class="w"> </span>--output<span class="w"> </span>./result_03
<span class="w">  </span>%<span class="w"> </span>Total<span class="w">    </span>%<span class="w"> </span>Received<span class="w"> </span>%<span class="w"> </span>Xferd<span class="w">  </span>Average<span class="w"> </span>Speed<span class="w">   </span>Time<span class="w">    </span>Time<span class="w">     </span>Time<span class="w">  </span>Current
<span class="w">                                 </span>Dload<span class="w">  </span>Upload<span class="w">   </span>Total<span class="w">   </span>Spent<span class="w">    </span>Left<span class="w">  </span>Speed
<span class="w">  </span><span class="m">0</span><span class="w"> </span>2539M<span class="w">    </span><span class="m">0</span><span class="w"> </span><span class="m">13</span>.3M<span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">  </span><span class="m">81082</span><span class="w">      </span><span class="m">0</span><span class="w">  </span><span class="m">9</span>:07:22<span class="w">  </span><span class="m">0</span>:02:52<span class="w">  </span><span class="m">9</span>:04:30<span class="w"> </span><span class="m">81157</span>
</pre></div>
<p><figure style="flex: 219.01960784313727" ><img width="2234" height="510" src="https://raw.githubusercontent.com/iYangcw/Photo/master/image-20230426200129823.png" /><figcaption>image-20230426200129823</figcaption></figure></p>
<p>Window Scaling 截图，绿线后面稳定的时候，值是 182272，和抓包截图里 Client 的 win=182272 也对应的上，win 是 client 向对方声明自己的接收窗口。从下载网速来看也就是虽然 client 声明了自己的接收窗口很大，但是 server 端的 wmem 比较小，所以网速也不快。</p>
<p><figure style="flex: 79.36241610738254" ><img width="1892" height="1192" src="https://raw.githubusercontent.com/iYangcw/Photo/master/image-20230426193723153.png" /><figcaption>image-20230426193723153</figcaption></figure></p>
<p>一个笔直的蓝色线 对应的从 No 180-182，对应的大小为：2896、5792、8192，抓包见下面截图，和抓包详情截图的 Len 字段也对得上。</p>
<p>wireshark 的 Length 列 减去 66 ，就等于包详情里的 Len，至于为什么是 66 不太清楚，但是可以从 ACK 响应是 66 辅助确认。</p>
<p><figure style="flex: 69.82758620689656" ><img width="1701" height="1218" src="https://raw.githubusercontent.com/iYangcw/Photo/master/image-20230426195023142.png" /><figcaption>image-20230426195023142</figcaption></figure></p>
<h2>实验五：server 增加 10ms 延时，client 修改 rmem</h2>
<div class="highlight"><pre><span></span><span class="c1"># 两边原始值</span>
sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_wmem<span class="o">=</span><span class="s2">&quot;4096 16384 4194304&quot;</span>
sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_rmem<span class="o">=</span><span class="s2">&quot;4096 87380 6291456&quot;</span>
<span class="c1"># Server</span>
tc<span class="w"> </span>qdisc<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>enp0s8
tc<span class="w"> </span>qdisc<span class="w"> </span>del<span class="w"> </span>dev<span class="w"> </span>enp0s8<span class="w"> </span>root
tc<span class="w"> </span>qdisc<span class="w"> </span>add<span class="w"> </span>dev<span class="w"> </span>enp0s8<span class="w"> </span>root<span class="w"> </span>netem<span class="w"> </span>delay<span class="w"> </span>10ms
<span class="c1"># client</span>
sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.tcp_rmem<span class="o">=</span><span class="s2">&quot;4096 4096 4096&quot;</span>

<span class="c1"># Client</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>enp0s8<span class="w"> </span>-n<span class="w"> </span>host<span class="w">  </span><span class="si">${</span><span class="nv">serverIP</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span>client_delayServer_10ms_rmem_Client_4096.pcap
<span class="c1"># Server</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>enp0s8<span class="w"> </span>-n<span class="w"> </span>host<span class="w">  </span><span class="si">${</span><span class="nv">clientIP</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span>server_delayServer_10ms_rmem_Client_4096.pcap

<span class="c1"># 结果, 大概平均下载速度是 123 KB/s</span>
$<span class="w"> </span>curl<span class="w"> </span>http://192.168.56.101:8089/iso.tar<span class="w"> </span>--output<span class="w"> </span>./result_01
<span class="w">  </span>%<span class="w"> </span>Total<span class="w">    </span>%<span class="w"> </span>Received<span class="w"> </span>%<span class="w"> </span>Xferd<span class="w">  </span>Average<span class="w"> </span>Speed<span class="w">   </span>Time<span class="w">    </span>Time<span class="w">     </span>Time<span class="w">  </span>Current
<span class="w">                                 </span>Dload<span class="w">  </span>Upload<span class="w">   </span>Total<span class="w">   </span>Spent<span class="w">    </span>Left<span class="w">  </span>Speed
<span class="w">  </span><span class="m">0</span><span class="w"> </span>2539M<span class="w">    </span><span class="m">0</span><span class="w"> </span><span class="m">20</span>.6M<span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">   </span>123k<span class="w">      </span><span class="m">0</span><span class="w">  </span><span class="m">5</span>:50:08<span class="w">  </span><span class="m">0</span>:02:50<span class="w">  </span><span class="m">5</span>:47:18<span class="w">  </span>123k
</pre></div>
<p>见 <strong>结论二</strong> 截图</p>
<h2>实验六：curl 增加速度控制</h2>
<div class="highlight"><pre><span></span><span class="c1"># client &amp; server 保持默认值不动，限速设置小一点，抓包分析更好一点，分别尝试了1k、100k、1M</span>
curl<span class="w"> </span>--limit-rate<span class="w"> </span>1k<span class="w"> </span>http://192.168.56.101:8089/iso.tar<span class="w"> </span>--output<span class="w"> </span>./result_04

<span class="c1"># Client</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>enp0s8<span class="w"> </span>-n<span class="w"> </span>host<span class="w">  </span><span class="si">${</span><span class="nv">serverIP</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span>client_curl_1k.pcap
<span class="c1"># Server</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>enp0s8<span class="w"> </span>-n<span class="w"> </span>host<span class="w">  </span><span class="si">${</span><span class="nv">clientIP</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span>server_curl_1k.pcap
</pre></div>
<p>TCP Window Full 意味着窗口填满，可以看下这篇文章，说的很详细：<a href="https://www.golinuxcloud.com/wireshark-tcp-zero-window/">Analyse Slow Networks with TCP Zero Window</a></p>
<p><figure style="flex: 106.85344827586206" ><img width="2479" height="1160" src="https://raw.githubusercontent.com/iYangcw/Photo/master/image-20230427171447952.png" /><figcaption>image-20230427171447952</figcaption></figure></p>
<h1>结论</h1>
<h2>结论一：改小 client rmem 和 server wmem 来对比对速度的影响</h2>
<p><strong>实验三 和 实验四</strong>：平均下载速度为：17 KB/s 和 80 KB/s 的对比</p>
<p>相比而言，server 改小了 wmen 速度还凑合，因为server 每次收到ack，立即释放 wmem 来发新的网络包 (内存级别的时延)；</p>
<p>如果 client 的 rmem 比较小，当 rmem 满了到应用读走 rmem，rmem 有空闲后需要 rtt 时间反馈到 server 端，server 端才会继续发包。（网络级时延比内存级时延高几个数量级）</p>
<p>一句话总结：就是 rmem 从有空到包进来会有很大的间隔 (rtt) , wmem 有空到写包进来没有时延。</p>
<p>plantegg 任总的这张图反复看，能有点理解了</p>
<p><figure style="flex: 138.15165876777252" ><img width="3498" height="1266" src="https://raw.githubusercontent.com/iYangcw/Photo/master/server%20_wmem_client_%20rmem.png" /></figure></p>
<p>时间比较</p>
<p><figure style="flex: 78.54077253218884" ><img width="732" height="466" src="https://raw.githubusercontent.com/iYangcw/Photo/master/time.png" /></figure></p>
<p>分析 实验三和实验四中 server 端抓包的结果：</p>
<p>实验三 rmen 的截图，从 No 15 开始看，差不多是 server &gt; client，【TCP Window Full 过会看】然后 No 17 中，client &gt; server ACK 回复，然后过了 0.1 秒，No 18 又开始发送给 client 了。</p>
<p>而且 TCP Window Full 很频繁，窗口被填满了，所以下载的速度很慢。截图里能看到 client 的 win=1460。</p>
<p>简单按照步骤描述下过程</p>
<p>1、No 11: client 表示我的接收窗口为 1460</p>
<p>2、No 12: server 表示我的接收窗口为 29056，以及发送了 730 长度的包</p>
<p>3、No 13: server 继续发送了 730 长度的包，由于 730 + 730 等于 client 的接收窗口 1460，所以提示 TCP WIndow Full</p>
<p>4、No 14: client 继续说我的接收窗口为 1460</p>
<p><figure style="flex: 153.87596899224806" ><img width="2382" height="774" src="https://raw.githubusercontent.com/iYangcw/Photo/master/rmem_client_4096.png" /></figure></p>
<p>实验四 wmen 的截图，server 几个包发给 client，然后 client ack 回复，反复该过程，包的发送比较平稳</p>
<p><figure style="flex: 157.04225352112675" ><img width="2230" height="710" src="https://raw.githubusercontent.com/iYangcw/Photo/master/wmem_server_4096.png" /></figure></p>
<h2>结论二：rmem 改小，查看 调整 rrt 后来对比速度</h2>
<p><strong>实验三 和 实验五</strong> 都是修改 client rmen = 4096，只是一个是 server 端设置了 100ms 和 10ms 延时，但是结果是 17 KB/s 和 123 KB/s 的差距。</p>
<p>rrt 增大了，下载速度会下降。下面两个截图，10ms 的 window Scaling 和 Throughput 都要比 100ms 的密集</p>
<p><figure style="flex: 155.5194805194805" ><img width="1916" height="616" src="https://raw.githubusercontent.com/iYangcw/Photo/master/rmem.png" /></figure></p>
<p><figure style="flex: 152.70700636942675" ><img width="1918" height="628" src="https://raw.githubusercontent.com/iYangcw/Photo/master/throughput.png" /></figure></p>
<p>plantegg 任总的这张图反复看【<strong>结论二的只需要看图片左边即可</strong>】，能有点理解了</p>
<p>延时增加了，那说明链路上的包也多了，client 接收包的速度慢了，那自然下载速度变慢。</p>
<p><figure style="flex: 81.1449159327462" ><img width="4054" height="2498" src="https://raw.githubusercontent.com/iYangcw/Photo/master/rmem_rtt.png" /><figcaption>rmem_rtt</figcaption></figure></p>
<h2>结论三：汇总：网速和 wmem rmem rtt 带宽 的关系</h2>
<p>减少 rtt 和 增大带宽 影响带宽就不说了。</p>
<p>client 的 recv buffer 太小 且 rtt 很大的情况下，网速会变慢。</p>
<p>增加 server 的 send buffer （对应 wmem），相当于仓库发货比较强</p>
<p>增加 client 的 recv buffer （对应 rmem），相当于仓库收获比较强</p>
<h1>ss 计算 tcp buffer size</h1>
<p><a href="https://man7.org/linux/man-pages/man8/ss.8.html">man ss 链接</a></p>
<div class="highlight"><pre><span></span><span class="c1"># 注意下，tb 表示 snd_buf，字母 t 可以理解为 Transmit</span>
<span class="w">       </span>-m,<span class="w"> </span>--memory
<span class="w">              </span>Show<span class="w"> </span>socket<span class="w"> </span>memory<span class="w"> </span>usage.<span class="w"> </span>The<span class="w"> </span>output<span class="w"> </span>format<span class="w"> </span>is:

<span class="w">              </span>skmem:<span class="o">(</span>r&lt;rmem_alloc&gt;,rb&lt;rcv_buf&gt;,t&lt;wmem_alloc&gt;,tb&lt;snd_buf&gt;,
<span class="w">                            </span>f&lt;fwd_alloc&gt;,w&lt;wmem_queued&gt;,o&lt;opt_mem&gt;,
<span class="w">                            </span>bl&lt;back_log&gt;,d&lt;sock_drop&gt;<span class="o">)</span>
</pre></div>
<h1>待办</h1>
<p>BDP</p>
<p>丢失率</p>
<h1>参考链接</h1>
<p><a href="https://www.golinuxcloud.com/wireshark-tcp-zero-window/">Analyse Slow Networks with TCP Zero Window</a></p>
<p><a href="https://plantegg.github.io/2019/09/28/%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82TCP--%E6%80%A7%E8%83%BD%E5%92%8C%E5%8F%91%E9%80%81%E6%8E%A5%E6%94%B6Buffer%E7%9A%84%E5%85%B3%E7%B3%BB/">TCP性能和发送接收窗口、Buffer的关系</a></p>
<p><a href="https://blog.csdn.net/dog250/article/details/113020804">长肥管道(LFT)中TCP的艰难处境与打法</a></p>
<p><a href="https://www.cisco.com/c/en/us/support/docs/ip/transmission-control-protocol-tcp/200943-Why-Your-Application-only-Uses-10Mbps-Ev.html">Why Your Application only Uses 10Mbps Even the Link is 1Gbps?</a></p>
<p><a href="https://www.switch.ch/network/tools/tcp_throughput/">TCP Throughput Calculator</a></p>

            </div>
        </article>
        <div id="ga-tags">
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/Blog-With-GitHub-Boilerplate/tag/TCP/">#TCP</a>
    </span>
    
</div>
    </section>

    
<section id="ga-content_pager">

    <div class="next">
        <h3>没有了</h3>
        <p class="yue">这是最新的文章</p>
    </div>


    <div class="prev">
        <a class="ga-highlight" href="/Blog-With-GitHub-Boilerplate/archives/TCP/">TCP半连接和全连接队列</a>
        <p class="yue">关于TCP半连接和全连接队列问题</p>
    </div>

</section>


    

</main>

                <footer class="ga-mono" id="ga-footer">
                    <section>
                        <span id="ga-uptime"></span>
                        <span class="brand">个人博客</span>
                    </section>
                    <section>
                        <p class="copyright">
                            <span>Copyright © 2023 Clover</span>
                            <span>Powered by <a no-style href="https://github.com/AlanDecode/Maverick" target="_blank">Maverick & Galileo</a></span>
                        </p>
                        <div class="copyright">
                            <span class="footer-addon">
                                
                            </span>
                            <nav class="social-links">
                                <ul><li><a class="no-style" title="Twitter" href="https://twitter.com/iCloverLL" target="_blank"><i class="gi gi-twitter"></i>Twitter</a></li></ul>
                            </nav>
                        </div>
                    </section>
                    <script>
                        var site_build_date = "2019-12-18T16:51+08:00"
                    </script>
                    <script src="/Blog-With-GitHub-Boilerplate/assets/galileo-dc4baa7cf4.js"></script>
                </footer>
            </div>
        </div>
    </div>

    <!--katex-->
    <script defer src="/Blog-With-GitHub-Boilerplate/assets/katex.min.js"></script>
    <script>
    mathOpts = {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\(", right: "\\)", display: false}
        ]
    };
    </script>
    <script defer src="/Blog-With-GitHub-Boilerplate/assets/auto-render.min.js" onload="renderMathInElement(document.body, mathOpts);"></script>

    <script src="/Blog-With-GitHub-Boilerplate/assets/ExSearch/jquery.min.js"></script>
    <script src="/Blog-With-GitHub-Boilerplate/assets/ExSearch/ExSearch-493cb9cd89.js"></script>

    
    </body>
</html>